<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>China ElecTRADE Daily Market</title>

    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px auto;
            max-width: 1600px;   /* increase this */
        }


        h2 {
            margin-top: 50px;
        }

        #priceChart, #socChart {
            width: 100%;
            height: 600px;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>

<h1>China ElecTRADE — Daily Results</h1>

<h2>Hourly Nodal Prices</h2>
<div id="priceChart"></div>

<h2>Final Storage SOC</h2>
<div id="socChart"></div>

<div id="error" class="error"></div>

<script>

console.log("ElecTRADE site initialized");

// Cache-busting to avoid GitHub Pages CDN cache
const cacheBuster = "?v=" + new Date().getTime();

// Load index.json
fetch("data/index.json" + cacheBuster)
.then(response => {
    if (!response.ok) {
        throw new Error("index.json not found");
    }
    return response.json();
})
.then(config => {

    console.log("Index loaded:", config);

    if (!config.price_files || config.price_files.length === 0) {
        throw new Error("No price files found in index.json");
    }

    // Get latest price file
    const latestPrice = config.price_files.sort().reverse()[0];

    console.log("Latest price file:", latestPrice);

    // ==========================
    // Load price CSV
    // ==========================
    return d3.csv("data/prices/" + latestPrice + cacheBuster)
    .then(data => {

        if (!data || data.length === 0) {
            throw new Error("Price CSV empty");
        }

  
        const snapshotKey = Object.keys(data[0])[0];
        const timestamps = data.map(d => d[snapshotKey]);

        const columns = Object.keys(data[0]);

        // Keep only provincial price columns
        const provinces = columns.filter(c =>
            c !== "snapshot" && !c.includes("__")
        );

        const traces = provinces.map(zone => ({
            x: timestamps,
            y: data.map(d => +d[zone]),
            mode: "lines",
            name: zone
        }));

        Plotly.newPlot("priceChart", traces, {
            title: "Prices — " + latestPrice,
            xaxis: { title: "Time" },
            yaxis: { title: "Price (€/MWh)" }
        });

        return config;  // pass forward
    });

})
.then(config => {

    // ==========================
    // Load SOC CSV
    // ==========================
    return d3.csv("data/" + config.soc_file + cacheBuster)
    .then(data => {

        if (!data || data.length === 0) {
            throw new Error("SOC CSV empty");
        }

        const names = data.map(d => d.name);
        const values = data.map(d => +Object.values(d)[1]);

        Plotly.newPlot("socChart", [{
            x: names,
            y: values,
            type: "bar"
        }], {
            title: "Final Storage SOC",
            xaxis: { title: "Storage Unit" },
            yaxis: { title: "Energy (MWh)" }
        });

    });

})
.catch(error => {
    console.error("ERROR:", error);
    document.getElementById("error").innerText =
        "Error loading data: " + error.message;
});

</script>

</body>
</html>