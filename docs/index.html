<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>China ElecTRADE Daily Market</title>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px auto;
    max-width: 1600px;
}
h2 { margin-top: 40px; }
#priceMap, #provinceCurve { height: 650px; }
#socChart { height: 600px; }
</style>
</head>

<body>

<h1>China ElecTRADE — Daily Results</h1>

<div style="display:flex; gap:30px;">
    <div style="flex:1;">
        <h2>Provincial Price Distribution (24h Avg)</h2>
        <div id="priceMap"></div>
    </div>
    <div style="flex:1;">
        <h2 id="curveTitle">Hourly Price</h2>
        <div id="provinceCurve"></div>
    </div>
</div>

<h2>Final Storage SOC</h2>
<div id="socChart"></div>

<div id="error" style="color:red;"></div>

<script>

let mapInstance;
let hoverPopup;

/* ---------- CSV Loader ---------- */

async function loadCSV(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("CSV not found: " + url);
    const text = await res.text();
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");
    return rows.slice(1).map(row => {
        const values = row.split(",");
        return Object.fromEntries(
            headers.map((h,i) => [h.trim(), values[i]])
        );
    });
}

/* ---------- MAIN ---------- */

async function loadApp() {

    try {

        const config = await fetch("out/index.json")
            .then(r => r.json());

        const latestPrice =
            config.price_files.sort().reverse()[0];

        const priceData = await loadCSV(
            "out/prices/" + latestPrice
        );

        const columns = Object.keys(priceData[0]);
        const provinces = columns.filter(c =>
            c !== "snapshot" && !c.includes("__")
        );

        const timestamps = priceData.map(d => d.snapshot);

        let avgPrice = {};
        provinces.forEach(zone => {
            const vals = priceData.map(d => +d[zone]);
            avgPrice[zone] =
                vals.reduce((a,b)=>a+b,0) / vals.length;
        });

        initMap(avgPrice, priceData, timestamps);

        const socData = await loadCSV(
            "out/" + config.soc_file
        );

        Plotly.newPlot("socChart", [{
            x: socData.map(d => d.name),
            y: socData.map(d => +Object.values(d)[1]),
            type: "bar"
        }], {
            title: "Final Storage SOC",
            xaxis: { title: "Storage Unit" },
            yaxis: { title: "Energy (MWh)" }
        });

    } catch (err) {
        document.getElementById("error").innerText =
            err.message;
        console.error(err);
    }
}

/* ---------- MAP ---------- */

function initMap(avgPrice, data, timestamps) {

    mapInstance = new maplibregl.Map({
        container: 'priceMap',
        style: "https://demotiles.maplibre.org/style.json"
    });

    mapInstance.on('load', async () => {

        const geo = await fetch("geo/china_33nodes.geojson")
            .then(r => r.json());

        /* -------- Force correct viewport -------- */

        const bounds = new maplibregl.LngLatBounds();

        geo.features.forEach(f => {
            const coords = f.geometry.coordinates.flat(3);
            for (let i = 0; i < coords.length; i++) {
                bounds.extend(coords[i]);
            }
        });

        mapInstance.fitBounds(bounds, { padding: 20 });

        /* -------- Attach price -------- */

        geo.features.forEach(f => {
            const name = f.properties.name;
            const price = avgPrice[name] ?? 0;
            f.properties.price = price;
            f.properties.label = price.toFixed(0);
        });

        mapInstance.addSource('provinces', {
            type: 'geojson',
            data: geo
        });

        mapInstance.addLayer({
            id: 'province-fill',
            type: 'fill',
            source: 'provinces',
            paint: {
                'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'price'],
                    0, '#2166ac',
                    200, '#f7f7f7',
                    400, '#b2182b'
                ],
                'fill-opacity': 0.75
            }
        });

        mapInstance.addLayer({
            id: 'province-border',
            type: 'line',
            source: 'provinces',
            paint: {
                'line-color': '#000',
                'line-width': 1.2
            }
        });

        mapInstance.addLayer({
            id: 'province-label',
            type: 'symbol',
            source: 'provinces',
            layout: {
                'text-field': ['get', 'label'],
                'text-size': 14
            },
            paint: {
                'text-color': '#000',
                'text-halo-color': '#fff',
                'text-halo-width': 1.5
            }
        });

        hoverPopup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        mapInstance.on('mousemove', 'province-fill', e => {
            const p = e.features[0].properties;
            hoverPopup
                .setLngLat(e.lngLat)
                .setHTML(`<b>${p.name}</b><br>Avg: ${p.price.toFixed(1)}`)
                .addTo(mapInstance);
        });

        mapInstance.on('mouseleave', 'province-fill', () => {
            hoverPopup.remove();
        });

        mapInstance.on('click', 'province-fill', e => {
            const zone = e.features[0].properties.name;
            showProvinceCurve(zone, data, timestamps);
        });

    });
}

/* ---------- CURVE ---------- */

function showProvinceCurve(zone, data, timestamps) {

    Plotly.newPlot("provinceCurve", [{
        x: timestamps,
        y: data.map(d => +d[zone]),
        mode: "lines+markers",
        name: zone
    }], {
        title: zone + " — Hourly Price",
        xaxis: { title: "Time" },
        yaxis: { title: "Price (€/MWh)" }
    });

    document.getElementById("curveTitle").innerText =
        "Hourly Price — " + zone;
}

loadApp();

</script>

</body>
</html>
